generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String     @id @default(uuid())
  displayName       String?    @unique
  email             String?    @unique
  password          String?
  status            UserStatus @default(offline)
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt
  onboarded         Boolean    @default(false)
  profilePictureUrl String?
  fullName          String?

  messages       Message[]      @relation("UserMessages")
  conversationsA Conversation[] @relation("convoA")
  conversationsB Conversation[] @relation("convoB")
  notifications  Notification[]
  readReceipts   ReadReceipt[]
  settings       Setting?
  friends        Friendship[]   @relation("UserFriends")
  friendOf       Friendship[]   @relation("FriendOfUser")
}

model Friendship {
  id        String       @id @default(uuid())
  userId    String
  friendId  String
  status    FriendStatus @default(pending)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  user   User @relation("UserFriends", fields: [userId], references: [id])
  friend User @relation("FriendOfUser", fields: [friendId], references: [id])

  @@unique([userId, friendId])
  @@index([userId])
  @@index([friendId])
}

model Conversation {
  id            String   @id @default(uuid())
  userAId       String
  userBId       String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  retentionDays Int      @default(7)

  userA User @relation("convoA", fields: [userAId], references: [id], onDelete: Cascade)
  userB User @relation("convoB", fields: [userBId], references: [id], onDelete: Cascade)

  messages Message[]

  @@unique([userAId, userBId])
  @@index([userAId])
  @@index([userBId])
}

model Message {
  id             String   @id @default(uuid())
  conversationId String
  senderId       String
  content        String
  sentAt         DateTime @default(now())
  updatedAt      DateTime @updatedAt

  deleted   Boolean   @default(false)
  deletedAt DateTime?
  expiresAt DateTime?

  conversation Conversation  @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender       User          @relation("UserMessages", fields: [senderId], references: [id])
  readReceipts ReadReceipt[]

  @@index([conversationId])
  @@index([expiresAt])
}

model ReadReceipt {
  id        String    @id @default(uuid())
  messageId String
  userId    String
  readAt    DateTime?

  message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id])

  @@unique([messageId, userId])
  @@index([userId])
}

model Setting {
  id                      String   @id @default(uuid())
  userId                  String   @unique
  theme                   String?
  notificationPreferences Json?
  language                String?
  chatHistoryRetention    String?
  statusVisibility        String?
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])
}

model Notification {
  id        String   @id @default(uuid())
  userId    String
  type      String
  content   String
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
}

enum UserStatus {
  online
  offline
}

enum FriendStatus {
  pending
  accepted
  refused
  blocked
}
